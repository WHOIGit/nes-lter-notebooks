---
title: "nes-lter-nutrients-transect-emlassemblyline"
author: "Stace Beaulieu"
date: "May 9, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document.

## Make data table by concatenating cruises called from API

```{r}
# List of cruises to acquire from 2017-09 to 2019-02: AR22, AR24A, AR24B, [can we include AR24C?], EN608, [can we include AR28A?], AR28B, EN617, AR31A, [any OOI nutrients for AR31B or AR31C?], AR32, EN627

# read first cruise into data frame
# plural because I'll keep appending to it
previous_cruises <- read.csv('https://nes-lter-data.whoi.edu/api/nut/ar22.csv')
# create list of next cruises to concatenate
list_next_cruises <- list('ar24a','ar24b','en608','ar28b','en617','ar31a','ar32','en627')
for (k in 1:length(list_next_cruises)){
  full_path <- paste("https://nes-lter-data.whoi.edu/api/nut/",list_next_cruises[[k]],".csv", sep = "")
  next_cruise <- read.csv(full_path)
  all_cruises <- rbind(previous_cruises,next_cruise)
    if(k < length(list_next_cruises)) {
      previous_cruises <- all_cruises
      }
}

```

## Determine temporal coverage

```{r}
# Will need this in make_eml YYYY-MM-DD
column_of_dates <- as.Date(all_cruises$date)
startdate <- min(column_of_dates)
enddate <- max(column_of_dates)
# temporal.coverage argument is expecting objects of 'character' class, not 'Date'
startdate_as_character <- as.character(startdate)
enddate_as_character <- as.character(enddate)

```

## Plot positions as a check

```{r, echo=FALSE}
plot(all_cruises$longitude,all_cruises$latitude)  # scatterplot

```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.


## Determine geographic bounding box

```{r}
# Will need this order in make_eml: North, East, South, West
North <- max(all_cruises$latitude)
East <- max(all_cruises$longitude)
South <- min(all_cruises$latitude)
West <- min(all_cruises$longitude)

```

## Plot nutrients as a check

```{r, echo=FALSE}
plot(all_cruises$nitrate_nitrite)  # plot by row in data frame
plot(all_cruises$ammonium)  # plot by row in data frame
plot(all_cruises$phosphate)  # plot by row in data frame
plot(all_cruises$silicate)  # plot by row in data frame

```

## Determine if any nutrients values exceed expectations

```{r}
# In terms of global range check, I checked the following: nitrate less than 30 umol/l and ammonium less than 5 umol/l (based on Rees et al. 2006 https://doi.org/10.1016/j.dsr2.2006.05.008), phosphate less than 3 (I can't find a good reference quickly but this appears to be upper for Atlantic), silicate less than 60 (Elements of Physical Oceanography chapter on marine silica cycle, for deep Atlantic, this is probably too high). AR24B cast 4 has anomalously high ammonium, with samples 241, 242, and 243 higher than the global range check. Anything special about this cast, or these samples in particular?
if(any(all_cruises$nitrate_nitrite>30)) cat("nitrate_nitrite_exceeds") 
if(any(all_cruises$ammonium>5)) cat("ammonium_exceeds")
if(any(all_cruises$phosphate>3)) cat("phosphate_exceeds")
if(any(all_cruises$silicate>60)) cat("silicate_exceeds")

```

## Output the data table to csv file within the same folder as metadata files

```{r}
# use the same path as for the metadata tables for make_eml
# setwd("/Users/Stace/Desktop/nes-lter-nutrients-transect")  # desktop
setwd("/Users/sbeaulieu/Desktop/nes-lter-nutrients-transect") # laptop
write.csv(all_cruises, 'nes-lter-nutrients-transect.csv', row.names=FALSE)

```

## Ensure libraries are installed and open EMLassemblyline

```{r}
# ensure that EMLassemblyline is installed
# # Install devtools
# install.packages("devtools")
# 
# # Load devtools
# library(devtools)
# 
# # Install and load EMLassemblyline
# # if error during installation "cannot remove prior installation of package", restart RStudio and manually install that package
# install_github("EDIorg/EMLassemblyline")
library(EMLassemblyline)

```

## Make initial EML XML file

```{r}
# ensure metadata template txt files are UTF-8 and at specified path
# make_eml(path = "/Users/Stace/Desktop/nes-lter-nutrients-transect", # desktop
make_eml(path = "/Users/sbeaulieu/Desktop/nes-lter-nutrients-transect",
         dataset.title = "Dissolved inorganic nutrients from NES-LTER Transect cruises, including 4 macro-nutrients from water column bottle samples, ongoing since 2017",
         data.files = c('nes-lter-nutrients-transect.csv'),
         data.files.description = c("Dissolved inorganic nutrients measured from water column bottle samples taken on NES-LTER Transect cruises, ongoing since 2017, including nitrate + nitrite, ammonium, silicate, and phosphate."),
         temporal.coverage = c(startdate_as_character, enddate_as_character),
         geographic.description = "NES-LTER Transect",
         geographic.coordinates = c(North, East, South, West),
         maintenance.description = "ongoing",
         user.id = "NES",
         affiliation = "LTER",
         package.id = "knb-lter-nes.2.1")



```
<creators>
<publicationDate>
<abstract>
<keywordSet>
<intellectualRights>
<temporalCoverage>
<geographicCoverage>
<maintenance>
<contacts>
<methods>
<project>
<associatedParty>
<additionalInfo>
<dataTable> ... nes-lter-nutrients-transect.csv
running command 'CertUtil -hashfile "/Users/sbeaulieu/Desktop/nes-lter-nutrients-transect\nes-lter-nutrients-transect.csv" MD5' had status 1<additionalMetadata>
Compiling nodes
Writing knb-lter-nes.2.1.xml
Validating EML
EML passed validation!
Done.

